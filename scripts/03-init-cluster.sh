#!/bin/bash

echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo ">> Iniciando la configuración del cluster MySQL InnoDB Cluster <<"
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="

mysqlsh clusteradmin:cladmin@mysql-server-1:3306 --ssl-mode=DISABLED --js <<'EOF'
dba.configureInstance("clusteradmin@mysql-server-1:3306", {password: "cladmin", interactive:false, restart:true});
dba.configureInstance("clusteradmin@mysql-server-2:3306", {password: "cladmin", interactive:false, restart:true});
dba.configureInstance("clusteradmin@mysql-server-3:3306", {password: "cladmin", interactive:false, restart:true});
EOF

echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo ">>>>>>>>>>>> Esperando a que los nodos reinicien... <<<<<<<<<<<<<"
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="

sleep 30   # ← Ajusta esto según tu máquina

mysqlsh clusteradmin:cladmin@mysql-server-1:3306 --ssl-mode=DISABLED --js <<'EOF'
var cluster = dba.createCluster("plaxCluster", {memberSslMode: "DISABLED"});
cluster.addInstance("clusteradmin@mysql-server-2:3306", {password:"cladmin", recoveryMethod:"clone"});
cluster.addInstance("clusteradmin@mysql-server-3:3306", {password:"cladmin", recoveryMethod:"clone"});
EOF

sleep 10

mysqlsh clusteradmin:cladmin@mysql-server-1:3306 --ssl-mode=DISABLED --js <<'EOF'
dba.getCluster("plaxCluster").status();
EOF

echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo ">>>>>>>>> InnoDB Cluster configurado exitosamente!!! <<<<<<<<<<<<"
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="
echo "================================================================="